<!doctype html>
<html>

<head>
    <title>测试微信支付</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <script>(function(a){function b(){var b=f.clientWidth,c="}";!navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i)&&b>1024&&(b=640,c=";max-width:"+b+"px;margin-right:auto!important;margin-left:auto!important;}"),a.rem=b/16,/ZTE U930_TD/.test(navigator.userAgent)&&(a.rem=1.13*a.rem),h.innerHTML="html{font-size:"+a.rem+"px!important;}body{font-size:"+12*(b/320)+"px"+c}var c,d,e,f=document.documentElement,g=document.querySelector('meta[name="viewport"]'),h=document.createElement("style"),c=a.devicePixelRatio||1;if(d=1/c,!g)return void console.warn('\u8bf7\u8bbe\u7f6e\u9ed8\u8ba4viewport\u4e3a\uff1a<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />');if(/iPhone|iPad|iPod/i.test(navigator.userAgent)){var i=f.clientWidth;375===i&&g.setAttribute("content","user-scalable=no"),g.setAttribute("content","width="+c*i+",initial-scale="+d+",maximum-scale="+d+", minimum-scale="+d+",user-scalable=no")}else{var j=navigator.userAgent.match(/Android[\S\s]+AppleWebkit\/?(\d{3})/i);!j||j&&j[1]>534?g.setAttribute("content","target-densitydpi=device-dpi,width=device-width, initial-scale="+d+",maximum-scale="+d+", minimum-scale="+d):c=1}f.firstElementChild.appendChild(h),f.setAttribute("data-dpr",c),a.dpr=c,a.addEventListener("resize",function(){clearTimeout(e),e=setTimeout(b,300)},!1),a.addEventListener("pageshow",function(a){a.persisted&&(clearTimeout(e),e=setTimeout(b,300))},!1),b()})(window);
    </script>
    <style>@charset 'UTF-8';html{color:#000;background:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}article,aside,blockquote,body,button,code,dd,details,div,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul{margin:0;padding:0}input,select,textarea{font-size:100%}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}abbr,acronym{border:0;font-variant:normal}del{text-decoration:line-through}address,caption,cite,code,dfn,em,th,var{font-style:normal;font-weight:500}ol,ul{list-style:none}caption,th{text-align:left}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:500}q:after,q:before{content:''}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}a,ins{text-decoration:none}html{-webkit-tap-highlight-color:transparent}body,html{font-family:sans-serif}body{font-size:.6rem}.clearfix:after,.clearfix:before{content:' ';display:table}.clearfix:after{clear:both}
    </style>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script>window.jQuery || document.write('<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"><\/script>')</script>
    <!-- <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script> --><script src="../src/lib/jweixin-1.0.0.js"></script>
    <style>
      input.in {
        border: 1px solid #000;
      }
    </style>

</head>

<body>
    <header class="header" id="J_Header_Out">
        <div style="display:none;position:absolute;z-index:999;width:100%" id="J_InfoImg">
            <img src="../img/lead.png" style="width:100%" alt="微信分享请点右上角"/>
        </div>
        <div class="header-inner" id="J_Header">
          <a class="go-back" href="./../option.html?">
            <span class="icon arrow"></span>
          </a>
          <h1 id="J_Title">测试交易</h1>
        </div>
    </header>
    <section class="content">
      <div>
        <span>支付金额(元):</span>
        <input class="in" id="J_TotalFee"/>
      </div>
      <div>
        <span>用户Token:</span>
        <input class="in" id="J_UserToken" value="token4" />
      </div>
      <div>
        <a id="J_Submit" href="javascript:;" onclick="onSubmitOrder">确定入金</a>
      </div>
    </section>
    <script type="text/javascript">


      $('#J_Submit').on('click', $.proxy(this.onSubmitOrder, this));

      function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      function onBridgeReady(){
        $('#J_Submit').text('确定入金');

        WeixinJSBridge.invoke(
          'getBrandWCPayRequest', {
              "appId": window.pay_info.appId, //"wx2421b1c4370ec43b",     //公众号名称，由商户传入     
              "timeStamp": window.pay_info.timeStamp, //" 1395712654",         //时间戳，自1970年以来的秒数     
              "nonceStr": window.pay_info.nonceStr, // "e61463f8efa94090b1f366cccfbbb444", //随机串     
              "package": window.pay_info.package, // "prepay_id=u802345jgfjsdfgsdg888",     
              "signType": "MD5",         //微信签名方式：     
              "paySign": window.pay_info.paySign// "70EA570631E4BB79628FBCA90534C63FF7FADD89" //微信签名 
            },
            function(res){     
              if(res.err_msg == "get_brand_wcpay_request：ok" ) {}     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
               
              alert(res);
            }
        ); 
      }

      function onSubmitOrder() {

        $('#J_Submit').text('提交中...');

        var date = new Date();
        var minite = date.getMinutes();
        var second = date.getSeconds();
        var millsecond = date.getMilliseconds();
        var out_trade_no = 'dateng_' + minite + '' + second + '' + millsecond;

        var token = $('#J_UserToken').val();
        var total_fee = parseInt($('#J_TotalFee').val() == '' ? 0 : $('#J_TotalFee').val() * 100 );
    

        $.post("http://paytest.invhero.com:8100/v1/user/pay",
            {
              'method': 'submitOrderInfo',
              'out_trade_no': out_trade_no,
              'sub_openid': 'ovYT2jvYGwZ3r3A8G-KURqRJ2018', //'ovYT2jgPf6JYF1wZ_FcH4EqMwVR4',
              'body': '测试购买商品',
              'total_fee': total_fee,
              'mch_create_ip':'127.0.0.1',
              'access_token': token
            },
            function(result){
              // 这里写功能
              console.log(result);
              window.pay_info = eval('(' + result.data.xml.pay_info + ')');

              if (typeof WeixinJSBridge == "undefined"){
                 if( document.addEventListener ){
                     document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                 }else if (document.attachEvent){
                     document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
                     document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                 }
              }else{
                 onBridgeReady();
              }
        });
      }

    </script>
</body>
</html>